name: Auto PR Creation and Review

on:
  # Allow this workflow to be called from other repositories
  workflow_call:
    inputs:
      node_version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
      validate_command:
        description: 'Command to run for validation'
        required: false
        type: string
        default: 'npx @company/code-directives validate --fix'
    secrets:
      GITHUB_TOKEN:
        required: true
  
  # Also support direct usage in this repository
  push:
    branches: 
      - 'feature/**'
      - 'fix/**'
      - 'refactor/**'
      - 'docs/**'
      - 'hotfix/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version || '18' }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Comprehensive Test Validation
        uses: ./.github/workflows/comprehensive-test.yml
        with:
          node_version: ${{ inputs.node_version || '18' }}
          run_coverage: true
          coverage_threshold: 80
          fail_on_coverage: false
      
      - name: Run Best Practices Validation
        run: ${{ inputs.validate_command || 'npx @company/code-directives validate --fix' }}
        continue-on-error: true
      
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          existing_pr=$(gh pr list --head ${{ github.ref_name }} --json number --jq '.[0].number')
          
          if [ "$existing_pr" = "null" ] || [ -z "$existing_pr" ]; then
            # Create new PR
            gh pr create \
              --title "Auto: ${{ github.event.head_commit.message }}" \
              --body "## Automated PR Created by Best Practices SDK
              
              **Branch:** \`${{ github.ref_name }}\`
              **Commit:** ${{ github.sha }}
              
              ### Changes
              ${{ github.event.head_commit.message }}
              
              ### Automated Checks
              - ✅ Comprehensive test suite (unit, integration, coverage)
              - ✅ Code linting and formatting
              - ✅ Type checking (if TypeScript)
              - ✅ Security vulnerability scan
              - ✅ Best practices validation
              - ✅ Test coverage reporting
              
              ### Next Steps
              - Awaiting Claude code review
              - Will auto-merge if all checks pass
              
              ---
              *This PR was created automatically by the Best Practices SDK*"
            
            # Request Claude review
            sleep 2
            gh pr comment --body "@claude-code Please review this PR for code quality, security, and best practices compliance."
          else
            echo "PR already exists: #$existing_pr"
          fi